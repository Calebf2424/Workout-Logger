{% extends "base.html" %}
{% block title %}Create Routine â€“ Workout Tracker{% endblock %}

{% block content %}
  <h1 class="text-white fw-bold mb-4">
    {% if current_routine %}
      Routine: {{ current_routine.name }}
    {% else %}
      Create New Routine
    {% endif %}
  </h1>

  <!-- Toasts -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const tc = document.querySelector('.toast-container');
          {% for cat, msg in messages %}
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-bg-{{ 'danger' if cat=='danger' else 'success' }} border-0';
            toast.role = 'alert'; toast.ariaLive = 'assertive'; toast.ariaAtomic = 'true';
            toast.innerHTML = `
              <div class="d-flex">
                <div class="toast-body">{{ msg }}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast" aria-label="Close"></button>
              </div>`;
            tc.appendChild(toast);
            new bootstrap.Toast(toast, { delay: 1500 }).show();
          {% endfor %}
        });
      </script>
    {% endif %}
  {% endwith %}

  <!-- Form to add one exercise -->
  <form method="POST" action="{{ url_for('create_routine') }}" class="mb-4" style="max-width:400px;">
    {% if not current_routine %}
      <div class="mb-4 text-start">
        <label for="routine_name" class="form-label text-white fw-semibold">
          Routine Name
        </label>
        <input type="text"
               id="routine_name"
               name="routine_name"
               class="form-control"
               placeholder="e.g. Push Day"
               required>
      </div>
    {% endif %}

    <div class="mb-3 text-start">
      <label for="exercise" class="form-label text-white fw-semibold">Exercise</label>
      <select id="exercise"
              name="exercise"
              data-choices
              class="form-select"
              required>
        <option value="">Select exercise</option>
        {% for e in exercises %}
          <option value="{{ e.name }}">{{ e.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-4 text-start">
      <label for="sets" class="form-label text-white fw-semibold">Sets</label>
      <input type="number"
             id="sets"
             name="sets"
             class="form-control"
             min="1"
             value="1"
             required>
    </div>

    <button type="submit"
            name="action"
            value="add"
            class="btn btn-outline-light w-100 mb-2">
      âž• Add Exercise
    </button>
  </form>

  <!-- Form to save the routine (only after at least one add) -->
  {% if current_routine %}
    <form method="POST" action="{{ url_for('create_routine') }}" style="max-width:400px;">
      <button type="submit"
              name="action"
              value="save"
              class="btn btn-primary w-100 mb-4">
        ðŸ’¾ Save Routine
      </button>
    </form>
  {% endif %}

  <!-- List of exercises already added -->
  {% if current_sets %}
    <div class="w-100" style="max-width:400px;">
      <h5 class="text-white mb-2">Current Exercises</h5>
      <ul class="list-group">
        {% for item in current_sets %}
          <li class="list-group-item d-flex justify-content-between">
            {{ item.exercise }}
            <span>{{ item.sets }}Ã—</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
{% endblock %}

{% block page_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('select[data-choices]').forEach(el => {
        if (el.choices) el.choices.destroy();
        el.choices = new Choices(el, {
          searchEnabled: true,
          shouldSort: false,
          itemSelectText: ''
        });
      });
    });
  </script>
{% endblock %}
