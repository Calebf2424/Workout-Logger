{% extends "base.html" %}
{% block title %}Create Routine ‚Äì Workout Tracker{% endblock %}

{% block content %}
  <h1 class="text-white fw-bold mb-4">Create Routine</h1>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const toastContainer = document.querySelector('.toast-container');
          {% for msg in messages %}
          const toastEl = document.createElement('div');
          toastEl.className = 'toast align-items-center text-bg-success border-0';
          toastEl.role = 'alert'; toastEl.ariaLive = 'assertive'; toastEl.ariaAtomic = 'true';
          toastEl.innerHTML = `
            <div class="d-flex">
              <div class="toast-body">{{ msg }}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto"
                      data-bs-dismiss="toast" aria-label="Close"></button>
            </div>`;
          toastContainer.appendChild(toastEl);
          new bootstrap.Toast(toastEl, { delay: 1500 }).show();
          {% endfor %}
        });
      </script>
    {% endif %}
  {% endwith %}

  <div class="row justify-content-center w-100" style="max-width: 400px;">
    <div class="col-12">
      <div class="card home-card p-4">
        <form method="POST" action="{{ url_for('create_routine') }}">
          <!-- Routine Name (only on first render) -->
          {% if not current_routine %}
          <div class="mb-4">
            <label for="routine_name" class="form-label fw-semibold">Routine Name</label>
            <input type="text" id="routine_name" name="routine_name" class="form-control" placeholder="e.g. Push Day" required>
          </div>
          {% endif %}

          <!-- Exercise selector -->
          <div class="mb-4">
            <label for="exercise" class="form-label fw-semibold">Exercise</label>
            <select id="exercise" name="exercise" data-choices
                    class="form-select"
                    onchange="toggleCustomExercise(this.value)"
                    required>
              <option value="">Select exercise</option>
              <option value="__custom__">Custom Exercise</option>
              {% for e in exercises %}
                <option value="{{ e.name }}">{{ e.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Custom Exercise fields -->
          <div id="custom-fields" class="mb-4" style="display: none;">
            <div class="mb-3">
              <label for="custom_name" class="form-label fw-semibold">Custom Name</label>
              <input type="text" id="custom_name" name="custom_name" class="form-control">
            </div>
            <div>
              <label for="custom_muscle" class="form-label fw-semibold">Muscle Group</label>
              <select id="custom_muscle" name="custom_muscle" class="form-select">
                <option value="">Choose muscle group</option>
                {% for m in muscle_groups %}
                  <option value="{{ m }}">{{ m }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Submit -->
          <div class="d-flex">
            <button type="submit" name="action" value="add" class="btn btn-primary w-100 py-2">
              ‚ûï Add to Routine
            </button>
          </div>
        </form>
      </div>

      {% if current_sets %}
        <div class="mt-4">
          <h5 class="text-white mb-2">Current Exercises</h5>
          <ul class="list-group">
            {% for item in current_sets %}
              <li class="list-group-item d-flex justify-content-between">
                {{ item.exercise }}
                <span>{{ item.sets }}√ó</span>
              </li>
            {% endfor %}
          </ul>
        </div>

        <form method="POST" class="mt-3">
          <button type="submit" name="action" value="save" class="btn btn-success w-100">
            üíæ Save Routine
          </button>
        </form>

        <form method="POST" onsubmit="return confirmDiscard();" class="mt-2">
            <button type="submit" name="action" value="discard" class="btn btn-danger w-100">
              üóëÔ∏è Discard Routine
            </button>
          </form>          
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block page_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('select[data-choices]').forEach(el => {
        if (el.choices) el.choices.destroy();
        el.choices = new Choices(el, {
          searchEnabled: true,
          shouldSort: false,
          itemSelectText: ''
        });
      });
    });

    function toggleCustomExercise(value) {
      const cf = document.getElementById('custom-fields');
      if (value === '__custom__') {
        cf.style.display = 'block';
        document.getElementById('custom_name').required = true;
        document.getElementById('custom_muscle').required = true;
      } else {
        cf.style.display = 'none';
        document.getElementById('custom_name').required = false;
        document.getElementById('custom_muscle').required = false;
      }
    }
  </script>

  <script>
    function confirmDiscard() {
      return confirm("Are you sure you want to discard this routine?\nAll progress will be lost.");
    }
  </script>
{% endblock %}
